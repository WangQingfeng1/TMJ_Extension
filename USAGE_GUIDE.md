# TMJ Extension 使用指南

## 功能概述

TMJ Extension 包含四个核心模块:

### 1. Data Manager (数据管理)
- **选择配准图像**: 从已加载的体积中选择 Fixed 和 Moving Volume
- **导入新图像**: 或从文件加载新的医学影像
- **场景组织**: 将配准数据组织到**两层文件夹结构**中,便于管理

### 2. Gold Standard Set (金标准设置)
- **手动配准**: 使用相似变换进行互式手动配准
- **标注点管理**: 在配准后的图像上标注对应点对
- **金标准保存**: 保存手动配准后的金标准结果

### 3. Coarse Registration (粗配准)
- **基准点选择**: 在 Fixed 和 Moving Volume 上选择对应的基准点
- **自动配准**: 基于基准点对自动计算相似变换
- **配准评估**: 提供 RMS 误差评估配准精度
- **避免配准失败**: 为后续精配准提供良好的初始位置

### 4. ROI Mask Set (ROI掩膜设置)
- **自动生成掩膜**: 根据高分辨率ROI浮动图像的物理范围自动生成固定图像的ROI掩膜
- **膨胀处理**: 对掩膜进行膨胀，防止范围过于严格
- **精细配准准备**: 为后续基于ROI的精细配准提供掩膜约束

## 场景文件夹结构

插件采用**两层文件夹结构**来组织配准流程:

```
📁 TMJ_配准  (配准流程总文件夹)
   ├─ 📁 Data Manager  (数据管理模块)
   │  ├─ 📄 Fixed_Volume
   │  └─ 📄 Moving_Volume
   ├─ 📁 Gold Standard Set  (金标准设置模块)
   │  ├─ 📄 GoldStandard_Fixed
   │  ├─ 📄 GoldStandard_Moving
   │  ├─ 🔄 GoldStandard_Transform
   │  ├─ 📍 GoldStandard_Fixed_Fiducials
   │  └─ 📍 GoldStandard_Moving_Fiducials
   ├─ 📁 Coarse Registration  (粗配准模块)
   │  ├─ 📄 CoarseReg_Fixed
   │  ├─ 📄 CoarseReg_Moving
   │  ├─ 🔄 CoarseReg_Transform
   │  ├─ 📍 CoarseReg_Fixed_Fiducials
   │  ├─ 📍 CoarseReg_Moving_Fiducials
   │  └─ 📝 CoarseReg_Info
   └─ 📁 ROI Mask Set  (ROI掩膜设置模块)
      ├─ 📄 ROIMask_Fixed_Volume
      ├─ 📄 ROIMask_ROI_Moving_Volume
      └─ 🎭 ROI_Mask
```

**设计理念:**
- **总文件夹**: 代表整个 TMJ 配准流程,包含所有模块的结果
- **模块子文件夹**: 每个模块的输出独立存放,便于管理和追溯
- **可扩展**: 方便后续添加更多模块(配准、分割、测量等)

## 使用步骤

## 模块 1: Data Manager (数据管理)

### 方法一: 使用已加载的数据

1. 在 3D Slicer 中加载您的 CT 和 MR 图像
2. 打开 **TMJ Extension** 模块
3. 在 **Fixed Volume** 下拉框中选择 CT 图像 (提示: 通常选择 CT 图像作为固定图像)
4. 在 **Moving Volume** 下拉框中选择 MR 图像 (提示: 通常选择整体头颅MRI作为浮动图像)
5. **（可选）** 选择高分辨率ROI MRI图像：
   - 右斜矢位MRI - 右侧颞下颌关节斜矢状位扫描
   - 左斜矢位MRI - 左侧颞下颌关节斜矢状位扫描
   - 右斜冠位MRI - 右侧颞下颌关节斜冠状位扫描
   - 左斜冠位MRI - 左侧颞下颌关节斜冠状位扫描
6. 设置配准流程文件夹:
   - **总文件夹名称**: 默认为 `TMJ_配准`,代表整个配准流程
   - **模块子文件夹**: 默认为 `Data Manager`,存放当前模块的结果
7. 点击 **加载配准数据** 按钮

### 方法二: 导入新文件

1. 打开 **TMJ Extension** 模块
2. 点击 **加载 Fixed Volume** 按钮,选择 CT 图像文件
3. 点击 **加载 Moving Volume** 按钮,选择整体头颅MR 图像文件
4. **（可选）** 点击相应按钮加载高分辨率ROI MRI：
   - 点击 **加载右斜矢MRI** 按钮
   - 点击 **加载左斜矢MRI** 按钮
   - 点击 **加载右斜冠MRI** 按钮
   - 点击 **加载左斜冠MRI** 按钮
5. 设置总文件夹和模块子文件夹名称
6. 点击 **加载配准数据** 按钮

## 结果说明

加载成功后,您将在 3D Slicer 的 **Subject Hierarchy** (数据) 面板中看到:

```
📁 TMJ_配准  (总文件夹)
   └─ 📁 Data Manager  (模块子文件夹)
      ├─ 📄 Fixed_Volume  (CT 图像副本)
      ├─ 📄 Moving_Volume  (整体MRI 图像副本)
      ├─ 📄 ROI_Right_Sagittal  (右斜矢位MRI，可选)
      ├─ 📄 ROI_Left_Sagittal  (左斜矢位MRI，可选)
      ├─ 📄 ROI_Right_Coronal  (右斜冠位MRI，可选)
      └─ 📄 ROI_Left_Coronal  (左斜冠位MRI，可选)
```

**文件夹说明:**
- **总文件夹**: 如果已存在同名文件夹,将直接使用,不会重复创建
- **模块子文件夹**: 每次加载都会创建新的子文件夹
- **可扩展**: 后续模块(配准、分割等)的结果将添加到同一总文件夹下

## 重要提示

1. **数据类型提示**: 
   - Fixed Volume 通常是 CT 图像（CBCT）
   - Moving Volume 通常是整体头颅 MR 图像
   - ROI MRI 是针对颞下颌关节区域的高分辨率局部扫描
   - 这些只是提示,不会强制验证图像类型

2. **ROI MRI图像说明**:
   - 右斜矢/左斜矢：斜矢状位扫描，适合观察关节盘矢状面
   - 右斜冠/左斜冠：斜冠状位扫描，适合观察关节盘冠状面
   - 这些是可选的，根据实际采集的数据选择添加
   - 后续ROI Mask Set模块将使用这些高分辨率图像

3. **场景文件夹**: 
   - 文件夹仅在 3D Slicer 场景中创建
   - 不会创建磁盘上的物理文件夹
   - 如需保存,请使用 File → Save 保存整个场景

4. **数据副本**: 
   - 原始数据保持不变
   - 文件夹中的是数据副本
   - 所有图像信息(HU值、间距等)都会保留

5. **后续操作**: 
   - 可以在此文件夹中继续添加配准结果
   - ROI MRI图像将用于后续的ROI Mask Set模块
   - 方便管理整个配准流程的所有数据
   - 场景可以保存为 .mrb 或 .mrml 文件

## 日志查看

展开 **日志与错误信息** 区域查看详细操作记录:
- ✓ 表示成功操作
- ✗ 表示错误信息

## 模块 2: Gold Standard Set (金标准设置)

### 功能说明
Gold Standard Set 模块用于手动配准图像并设置金标准，为后续自动配准算法提供参考。

### 使用步骤

1. **选择数据**
   - 从 Data Manager 场景子文件夹中选择 Fixed_Volume 和 Moving_Volume
   - 或选择其他已加载的体积数据

2. **手动配准** (推荐先使用 Volume Rendering 模块进行三维渲染)
   - 选择或创建变换节点
   - 点击"应用变换到浮动图像"
   - 使用快捷控制滑块调整:
     - 平移: X, Y, Z 方向移动
     - 旋转: 绕 X, Y, Z 轴旋转
     - 统一缩放: 缩放图像大小 (保持比例)
   - 或点击"打开 Transforms 模块"进行详细调整

3. **标注点对管理** (可选)
   - 点击"放置点对"按钮 (持续放置模式)
   - 在配准后的位置点击放置基准点对
   - Fixed 点显示为红色，Moving 点显示为绿色
   - 完成后再次点击按钮退出放置模式

4. **保存金标准**
   - 设置 Gold Standard Set 场景子文件夹名称
   - 点击"保存金标准到场景"
   - 结果保存到配准流程总文件夹下

### 注意事项
- 手动配准使用相似变换 (平移+旋转+统一缩放)
- 建议先进行大致对齐，再使用标注点进行微调
- 金标准将用于后续配准算法的精度评估

## 模块 3: Coarse Registration (粗配准)

### 功能说明
Coarse Registration 模块基于基准点自动计算相似变换，将 Moving Volume 粗略对齐到 Fixed Volume，避免后续精配准因初始位置差异过大而失败。

### 使用步骤

1. **选择配准数据**
   - 从 Data Manager 场景子文件夹中选择 Fixed_Volume 和 Moving_Volume
   - 或选择其他已加载的体积数据

2. **创建基准点对** (分两步标注)
   
   **步骤 1: 标注 Fixed 基准点**
   - 点击"放置 Fixed 基准点"按钮
   - 在 Fixed Volume 上选择易识别的解剖标志点 (如骨性突起、关节面等)
   - Fixed 点显示为红色
   - 建议选择 3-10 个点，均匀分布在感兴趣区域
   - 完成后再次点击按钮退出放置模式
   
   **步骤 2: 标注 Moving 基准点**
   - 点击"放置 Moving 基准点"按钮
   - 在 Moving Volume 上选择**与 Fixed 点对应的**解剖标志点
   - Moving 点显示为绿色
   - **必须按照 Fixed 点的顺序**标注对应点
   - 确保点数与 Fixed 点相同
   - 完成后再次点击按钮退出放置模式

3. **执行粗配准**
   - 确认基准点对数量 ≥ 3
   - 点击"计算粗配准变换"
   - 系统自动计算相似变换矩阵

4. **保存粗配准结果**
   - 设置 Coarse Registration 场景子文件夹名称
   - 点击"保存粗配准结果到场景"
   - 结果包含:
     - CoarseReg_Moving: 粗配准后的浮动图像 (已绑定变换)
     - CoarseReg_Transform: 相似变换矩阵
     - CoarseReg_Fixed_Fiducials: Fixed 基准点 (红色)
     - CoarseReg_Moving_Fiducials: Moving 基准点 (绿色)
   - 原始的基准点节点将被自动删除

### 基准点选择技巧
1. **选择稳定的解剖标志点**: 如骨性突起、关节面、孔道等易识别的结构
2. **均匀分布**: 基准点应在感兴趣区域均匀分布
3. **避免对称结构**: 尽量避免完全对称的点，以免产生歧义
4. **数量建议**: 3-10 对基准点通常足够，过多可能引入噪声
5. **对应关系**: 确保 Fixed 和 Moving 上的点严格对应，按相同顺序标注
6. **清晰可见**: 选择在两个图像上都清晰可见的标志点

### 配准精度评估
- **变换参数**: 查看日志了解平移、旋转和缩放参数
- **可视化检查**: 使用 Volume Rendering 检查配准效果

## 常见问题

### Data Manager

**Q: 为什么提示 CT/MR?**  
A: 这只是常规配准流程的提示,您可以选择任何类型的体积数据。

**Q: 数据会被修改吗?**  
A: 不会,插件创建的是数据副本,原始数据不受影响。

**Q: 如何保存场景?**  
A: 使用 3D Slicer 的 File → Save 功能保存整个场景(.mrb 或 .mrml)。

**Q: 可以创建多个配准文件夹吗?**  
A: 可以,每次点击加载都会创建一个新的文件夹。

### Gold Standard Set

**Q: 为什么要设置金标准?**  
A: 金标准用于评估自动配准算法的精度,提供参考对比。

**Q: 手动配准精度要求高吗?**  
A: 尽可能精确,但不必过分追求完美,主要目的是提供参考。

**Q: 标注点是必须的吗?**  
A: 不是必须的,但有助于后续配准误差评估。

### Coarse Registration

**Q: 为什么需要粗配准?**  
A: 粗配准提供良好的初始对齐,避免后续基于互信息的精配准因初始位置差异过大而陷入局部最优或失败。

**Q: 基准点需要多少个?**  
A: 至少 3 个 (计算相似变换的最小要求),建议 5-10 个以提高精度和稳定性。

**Q: 如何评估配准质量？**  
A: 保存粗配准结果后，使用 Volume Rendering 可视化检查 Fixed 和配准后的 Moving 图像的对齐情况，特别是关注解剖结构是否对齐。

**Q: 如果配准效果不好怎么办？**  
A: 可能的原因和解决方法:
1. **基准点对应错误**: 检查 Fixed 和 Moving 上的点是否真正对应，顺序是否一致
2. **点数太少**: 增加基准点数量
3. **点分布不均**: 确保点在感兴趣区域均匀分布
4. **标注不准确**: 重新标注，确保点在两个图像上都准确定位到解剖标志点
5. **解剖变化**: 如果两个图像间存在显著的解剖变化，相似变换可能不够精确

**Q: 粗配准后还需要精配准吗?**  
A: 是的,粗配准只提供初始对齐,精配准 (如互信息法) 可进一步优化配准精度。

## 模块 4: ROI Mask Set (ROI掩膜设置)

### 功能说明
ROI Mask Set 模块用于生成颞下颌关节ROI区域的掩膜，为后续精细配准提供区域约束。基于高分辨率ROI浮动图像的物理范围自动生成固定图像的掩膜。

### 核心特性
- **异步处理**: 使用分块处理技术，生成掩膜时不阻塞UI，可随时切换到其他模块
- **实时进度**: 状态标签实时显示生成进度和百分比
- **可随时取消**: 提供取消按钮，可随时中断掩膜生成
- **自定义名称**: 可自定义生成的掩膜名称（默认：Fixed_ROI_Mask）
- **自动清理**: 保存后自动删除临时节点，保持场景整洁

### 应用场景
- **整体头颅MRI**: 分辨率较差
- **局部TMJ MRI**: 针对颞下颌关节区域的高分辨率扫描（如右斜矢位、左斜矢位）
- **粗配准基础**: 在粗配准后，CBCT和MRI已经大致对齐
- **精细配准需求**: 针对颞下颌关节盘等特定结构进行精确配准

### 使用步骤

1. **选择数据**
   - **Fixed Volume**: 从 Data Manager 场景文件夹中选择（通常是Fixed_Volume）
   - **ROI Moving Volume**: 从 Data Manager 场景文件夹中选择高分辨率ROI MRI：
     - ROI_Right_Sagittal (右斜矢位MRI)
     - ROI_Left_Sagittal (左斜矢位MRI)
     - ROI_Right_Coronal (右斜冠位MRI)
     - ROI_Left_Coronal (左斜冠位MRI)

2. **选择粗配准变换（强烈建议）**
   - 从 Coarse Registration 场景文件夹中选择 CoarseReg_Transform
   - 系统会自动将变换应用到ROI Moving Volume来计算掩膜
   - 如果不选择：系统会使用原始ROI Moving Volume的位置，可能导致掩膜位置不准确

3. **设置掩膜参数**
   - **膨胀量**: 调整膨胀量滑块（默认5mm，建议范围5-20mm）
     - 作用：防止掩膜范围过于严格，考虑粗配准误差
   - **掩膜名称**: 自定义掩膜名称（默认：Fixed_ROI_Mask）
     - 可根据ROI位置命名，如：Right_TMJ_Mask、Left_TMJ_Mask

4. **生成ROI掩膜**
   - 点击 **生成ROI掩膜** 按钮
   - 系统异步生成掩膜，不会阻塞界面
   - 状态标签实时显示进度：`状态: 正在生成掩膜... (45%)`
   - 可以切换到其他模块继续工作
   - 如需中断，点击 **取消** 按钮

5. **保存掩膜结果**
   - 生成完成后，点击 **保存ROI掩膜结果到场景**
   - 设置 ROI Mask Set 场景子文件夹名称（默认：ROI Mask Set）
   - 原始临时掩膜节点会自动删除
   - 结果保存到配准流程总文件夹下

### 掩膜生成原理（3步法）

**步骤1: 创建ROI LabelMap**
- 基于ROI Moving Volume的尺寸和体素间距
- 创建一个完全填充为1的LabelMap
- 尺寸 = 原始尺寸 + 2×膨胀体素数（每个方向两侧膨胀）
- 保持与ROI Moving Volume相同的几何信息（Origin、Direction、Spacing）

**步骤2: 应用粗配准变换**
- 如果提供了粗配准变换，将其应用到ROI LabelMap
- 使LabelMap与CBCT空间对齐
- 这是准确定位的关键步骤

**步骤3: 生成CBCT空间掩膜（异步处理）**
- 创建与CBCT完全一致的LabelMap（相同尺寸、Origin、Spacing、Direction）
- 使用分块异步处理（每次10行）
- 对CBCT的每个体素：
  - 转换到RAS物理空间
  - 再转换到ROI LabelMap的IJK空间
  - 判断是否在ROI LabelMap范围内
  - 在范围内则标记为1，否则为0
- 实时更新进度，保持UI响应

### 性能特性
- **分块处理**: 每次处理10行（约5000体素），避免UI冻结
- **进度更新**: 每完成一层更新一次进度（30%-90%）
- **UI响应**: 每个数据块处理后调用`processEvents()`保持响应
- **可中断**: 通过取消标志实现即时中断
- **平滑体验**: 与ANTS等专业插件同样流畅

### 注意事项

1. **强烈建议选择粗配准变换**
   - 这样生成的掩膜才能准确覆盖CBCT上的对应区域
   - 否则ROI MRI和CBCT的空间位置差异太大

2. **数据选择**
   - ROI Moving Volume 应该是高分辨率的局部MRI
   - 不要选择整体头颅MRI

3. **膨胀量选择**
   - 过小：可能遗漏感兴趣区域
   - 过大：引入过多无关区域
   - 建议：5-20mm（考虑粗配准误差）

4. **掩膜命名**
   - 建议根据ROI位置命名，便于识别
   - 例如：Right_TMJ_Mask、Left_Sagittal_Mask

5. **后续使用**
   - 生成的掩膜用于约束后续基于互信息的精细配准
   - 提高配准精度和效率

### 常见问题

**Q: 为什么要基于浮动图像制作固定图像的掩膜?**  
A: 因为高分辨率MRI已经集中在颞下颌关节区域了，直接利用其物理范围可以准确定位ROI。

**Q: 为什么要选择粗配准变换?**  
A: 粗配准后CBCT和MRI才大致对齐，此时根据变换后的MRI范围生成的掩膜才能准确覆盖CBCT上的对应区域。

**Q: 生成掩膜时可以做其他操作吗?**  
A: 可以！系统使用异步处理，不会阻塞界面，您可以切换到其他模块继续工作。

**Q: 如何知道生成进度?**  
A: 状态标签会实时显示进度信息和百分比，如"状态: 正在生成掩膜... (45%)"。

**Q: 生成过程可以中断吗?**  
A: 可以！点击"取消"按钮即可中断掩膜生成。

**Q: 膨胀量设置多少合适?**  
A: 建议5-20mm。因为是基于粗配准生成掩膜，需要一定的容差来覆盖可能的配准误差。

**Q: 可以为不同位置生成多个掩膜吗?**  
A: 可以！为不同的ROI MRI（右侧、左侧等）分别生成掩膜，并使用不同的名称保存。

**Q: 保存后原来的临时节点会删除吗?**  
A: 会的！系统会自动删除保存前的临时掩膜节点，只保留场景文件夹中的最终版本。

## 工作流程建议

### 推荐工作流程

1. **Data Manager**: 加载和组织配准数据
   - 加载整体头颅CBCT（固定图像）
   - 加载整体头颅MRI（浮动图像）
   - **加载4种高精度ROI MRI图像（右斜矢、左斜矢、右斜冠、左斜冠）**

2. **Coarse Registration**: 使用基准点进行粗配准
   - 在CBCT和整体MRI上标注对应基准点
   - 计算相似变换，实现粗对齐

3. **ROI Mask Set**: 基于高分辨率ROI MRI生成掩膜
   - 从Data Manager文件夹选择Fixed_Volume
   - 选择其中一个ROI MRI（如ROI_Right_Sagittal）
   - 对ROI MRI应用粗配准变换
   - 生成CBCT的ROI掩膜

4. **Gold Standard Set**: 手动精细配准设置金标准（可选，用于评估）
   - 在粗配准基础上进行手动微调
   - 保存作为金标准参考

5. **（后续模块）**: 基于互信息的自动精配准
   - 在ROI掩膜约束下进行精细配准
   - 针对颞下颌关节盘等特定结构

6. **（后续模块）**: 配准精度评估和可视化
   - 与金标准对比评估精度
   - 可视化配准结果

### 典型应用场景

**场景：颞下颌关节盘配准**

1. 数据准备：
   - CBCT：高分辨率整体头颅固定图像
   - MRI整体：低分辨率整体头颅MRI
   - MRI局部：**4种高分辨率颞下颌关节区域MRI**
     - 右斜矢位 (ROI_Right_Sagittal)
     - 左斜矢位 (ROI_Left_Sagittal)
     - 右斜冠位 (ROI_Right_Coronal)
     - 左斜冠位 (ROI_Left_Coronal)

2. **Data Manager阶段**：
   - 一次性将所有数据组织到场景文件夹
   - 包括固定图像、整体MRI和4种ROI MRI

3. 粗配准阶段：
   - 使用CBCT和MRI整体进行基准点粗配准
   - 目的：使整体结构大致对齐

4. ROI定位阶段：
   - 从Data Manager文件夹选择相应的ROI MRI
   - 应用粗配准变换到ROI MRI
   - 生成ROI掩膜，定位颞下颌关节区域
   - 可以为不同位置（右侧、左侧）分别生成掩膜

5. 精配准阶段（后续开发）：
   - 在ROI掩膜约束下
   - 针对颞下颌关节盘进行精细配准
   - 利用高分辨率ROI MRI提高配准精度
