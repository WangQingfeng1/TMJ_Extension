# TMJ Extension 使用指南

## 功能概述

TMJ Extension 包含三个核心模块:

### 1. Data Manager (数据管理)
- **选择配准图像**: 从已加载的体积中选择 Fixed 和 Moving Volume
- **导入新图像**: 或从文件加载新的医学影像
- **场景组织**: 将配准数据组织到**两层文件夹结构**中,便于管理

### 2. Gold Standard Set (金标准设置)
- **手动配准**: 使用相似变换进**Q: 基准点需要多少个？**  
A: 至少 3 个 (计算相似变换的最小要求),建议 5-10 个以提高精度和稳定性。Fixed 和 Moving 的点数必须相同。互式手动配准
- **标注点管理**: 在配准后的图像上标注对应点对
- **金标准保存**: 保存手动配准后的金标准结果

### 3. Coarse Registration (粗配准)
- **基准点选择**: 在 Fixed 和 Moving Volume 上选择对应的基准点
- **自动配准**: 基于基准点对自动计算相似变换
- **配准评估**: 提供 RMS 误差评估配准精度
- **避免配准失败**: 为后续精配准提供良好的初始位置

## 场景文件夹结构

插件采用**两层文件夹结构**来组织配准流程:

```
📁 TMJ_配准  (配准流程总文件夹)
   ├─ 📁 Data Manager  (数据管理模块)
   │  ├─ 📄 Fixed_Volume
   │  └─ 📄 Moving_Volume
   ├─ 📁 Gold Standard Set  (金标准设置模块)
   │  ├─ 📄 GoldStandard_Fixed
   │  ├─ 📄 GoldStandard_Moving
   │  ├─ 🔄 GoldStandard_Transform
   │  ├─ 📍 GoldStandard_Fixed_Fiducials
   │  └─ � GoldStandard_Moving_Fiducials
   └─ �📁 Coarse Registration  (粗配准模块)
      ├─ 📄 CoarseReg_Fixed
      ├─ 📄 CoarseReg_Moving
      ├─ 🔄 CoarseReg_Transform
      ├─ 📍 CoarseReg_Fixed_Fiducials
      ├─ 📍 CoarseReg_Moving_Fiducials
      └─ 📝 CoarseReg_Info
```

**设计理念:**
- **总文件夹**: 代表整个 TMJ 配准流程,包含所有模块的结果
- **模块子文件夹**: 每个模块的输出独立存放,便于管理和追溯
- **可扩展**: 方便后续添加更多模块(配准、分割、测量等)

## 使用步骤

## 模块 1: Data Manager (数据管理)

### 方法一: 使用已加载的数据

1. 在 3D Slicer 中加载您的 CT 和 MR 图像
2. 打开 **TMJ Extension** 模块
3. 在 **Fixed Volume** 下拉框中选择 CT 图像 (提示: 通常选择 CT 图像作为固定图像)
4. 在 **Moving Volume** 下拉框中选择 MR 图像 (提示: 通常选择 MR 图像作为浮动图像)
5. 设置配准流程文件夹:
   - **总文件夹名称**: 默认为 `TMJ_配准流程_日期时间`,代表整个配准流程
   - **模块1子文件夹**: 默认为 `模块1_数据管理`,存放当前模块的结果
6. 点击 **加载配准数据** 按钮

### 方法二: 导入新文件

1. 打开 **TMJ Extension** 模块
2. 点击 **加载 Fixed Volume** 按钮,选择 CT 图像文件
3. 点击 **加载 Moving Volume** 按钮,选择 MR 图像文件
4. 设置总文件夹和模块子文件夹名称
5. 点击 **加载配准数据** 按钮

## 结果说明

加载成功后,您将在 3D Slicer 的 **Subject Hierarchy** (数据) 面板中看到:

```
📁 TMJ_配准流程_20250122_143020  (总文件夹)
   └─ � 模块1_数据管理  (模块1子文件夹)
      ├─ �📄 Fixed_Volume  (CT 图像副本)
      └─ 📄 Moving_Volume  (MR 图像副本)
```

**文件夹说明:**
- **总文件夹**: 如果已存在同名文件夹,将直接使用,不会重复创建
- **模块子文件夹**: 每次加载都会创建新的子文件夹
- **可扩展**: 后续模块(配准、分割等)的结果将添加到同一总文件夹下

## 重要提示

1. **数据类型提示**: 
   - Fixed Volume 通常是 CT 图像
   - Moving Volume 通常是 MR 图像
   - 这些只是提示,不会强制验证图像类型

2. **场景文件夹**: 
   - 文件夹仅在 3D Slicer 场景中创建
   - 不会创建磁盘上的物理文件夹
   - 如需保存,请使用 File → Save 保存整个场景

3. **数据副本**: 
   - 原始数据保持不变
   - 文件夹中的是数据副本
   - 所有图像信息(HU值、间距等)都会保留

4. **后续操作**: 
   - 可以在此文件夹中继续添加配准结果
   - 方便管理整个配准流程的所有数据
   - 场景可以保存为 .mrb 或 .mrml 文件

## 日志查看

展开 **日志与错误信息** 区域查看详细操作记录:
- ✓ 表示成功操作
- ✗ 表示错误信息

## 模块 2: Gold Standard Set (金标准设置)

### 功能说明
Gold Standard Set 模块用于手动配准图像并设置金标准，为后续自动配准算法提供参考。

### 使用步骤

1. **选择数据**
   - 从 Data Manager 场景子文件夹中选择 Fixed_Volume 和 Moving_Volume
   - 或选择其他已加载的体积数据

2. **手动配准** (推荐先使用 Volume Rendering 模块进行三维渲染)
   - 选择或创建变换节点
   - 点击"应用变换到浮动图像"
   - 使用快捷控制滑块调整:
     - 平移: X, Y, Z 方向移动
     - 旋转: 绕 X, Y, Z 轴旋转
     - 统一缩放: 缩放图像大小 (保持比例)
   - 或点击"打开 Transforms 模块"进行详细调整

3. **标注点对管理** (可选)
   - 点击"放置点对"按钮 (持续放置模式)
   - 在配准后的位置点击放置基准点对
   - Fixed 点显示为红色，Moving 点显示为绿色
   - 完成后再次点击按钮退出放置模式

4. **保存金标准**
   - 设置 Gold Standard Set 场景子文件夹名称
   - 点击"保存金标准到场景"
   - 结果保存到配准流程总文件夹下

### 注意事项
- 手动配准使用相似变换 (平移+旋转+统一缩放)
- 建议先进行大致对齐，再使用标注点进行微调
- 金标准将用于后续配准算法的精度评估

## 模块 3: Coarse Registration (粗配准)

### 功能说明
Coarse Registration 模块基于基准点自动计算相似变换，将 Moving Volume 粗略对齐到 Fixed Volume，避免后续精配准因初始位置差异过大而失败。

### 使用步骤

1. **选择配准数据**
   - 从 Data Manager 场景子文件夹中选择 Fixed_Volume 和 Moving_Volume
   - 或选择其他已加载的体积数据

2. **创建基准点对** (分两步标注)
   
   **步骤 1: 标注 Fixed 基准点**
   - 点击"放置 Fixed 基准点"按钮
   - 在 Fixed Volume 上选择易识别的解剖标志点 (如骨性突起、关节面等)
   - Fixed 点显示为红色
   - 建议选择 3-10 个点，均匀分布在感兴趣区域
   - 完成后再次点击按钮退出放置模式
   
   **步骤 2: 标注 Moving 基准点**
   - 点击"放置 Moving 基准点"按钮
   - 在 Moving Volume 上选择**与 Fixed 点对应的**解剖标志点
   - Moving 点显示为绿色
   - **必须按照 Fixed 点的顺序**标注对应点
   - 确保点数与 Fixed 点相同
   - 完成后再次点击按钮退出放置模式

3. **执行粗配准**
   - 确认基准点对数量 ≥ 3
   - 点击"计算粗配准变换"
   - 系统自动计算相似变换矩阵

4. **保存粗配准结果**
   - 设置 Coarse Registration 场景子文件夹名称
   - 点击"保存粗配准结果到场景"
   - 结果包含:
     - CoarseReg_Moving: 粗配准后的浮动图像 (已绑定变换)
     - CoarseReg_Transform: 相似变换矩阵
     - CoarseReg_Fixed_Fiducials: Fixed 基准点 (红色)
     - CoarseReg_Moving_Fiducials: Moving 基准点 (绿色)
   - 原始的基准点节点将被自动删除

### 基准点选择技巧
1. **选择稳定的解剖标志点**: 如骨性突起、关节面、孔道等易识别的结构
2. **均匀分布**: 基准点应在感兴趣区域均匀分布
3. **避免对称结构**: 尽量避免完全对称的点，以免产生歧义
4. **数量建议**: 3-10 对基准点通常足够，过多可能引入噪声
5. **对应关系**: 确保 Fixed 和 Moving 上的点严格对应，按相同顺序标注
6. **清晰可见**: 选择在两个图像上都清晰可见的标志点

### 配准精度评估
- **变换参数**: 查看日志了解平移、旋转和缩放参数
- **可视化检查**: 使用 Volume Rendering 检查配准效果

## 常见问题

### Data Manager

**Q: 为什么提示 CT/MR?**  
A: 这只是常规配准流程的提示,您可以选择任何类型的体积数据。

**Q: 数据会被修改吗?**  
A: 不会,插件创建的是数据副本,原始数据不受影响。

**Q: 如何保存场景?**  
A: 使用 3D Slicer 的 File → Save 功能保存整个场景(.mrb 或 .mrml)。

**Q: 可以创建多个配准文件夹吗?**  
A: 可以,每次点击加载都会创建一个新的文件夹。

### Gold Standard Set

**Q: 为什么要设置金标准?**  
A: 金标准用于评估自动配准算法的精度,提供参考对比。

**Q: 手动配准精度要求高吗?**  
A: 尽可能精确,但不必过分追求完美,主要目的是提供参考。

**Q: 标注点是必须的吗?**  
A: 不是必须的,但有助于后续配准误差评估。

### Coarse Registration

**Q: 为什么需要粗配准?**  
A: 粗配准提供良好的初始对齐,避免后续基于互信息的精配准因初始位置差异过大而陷入局部最优或失败。

**Q: 基准点需要多少个?**  
A: 至少 3 个 (计算相似变换的最小要求),建议 5-10 个以提高精度和稳定性。

**Q: 如何评估配准质量？**  
A: 保存粗配准结果后，使用 Volume Rendering 可视化检查 Fixed 和配准后的 Moving 图像的对齐情况，特别是关注解剖结构是否对齐。

**Q: 如果配准效果不好怎么办？**  
A: 可能的原因和解决方法:
1. **基准点对应错误**: 检查 Fixed 和 Moving 上的点是否真正对应，顺序是否一致
2. **点数太少**: 增加基准点数量
3. **点分布不均**: 确保点在感兴趣区域均匀分布
4. **标注不准确**: 重新标注，确保点在两个图像上都准确定位到解剖标志点
5. **解剖变化**: 如果两个图像间存在显著的解剖变化，相似变换可能不够精确

**Q: 粗配准后还需要精配准吗?**  
A: 是的,粗配准只提供初始对齐,精配准 (如互信息法) 可进一步优化配准精度。

## 工作流程建议

1. **Data Manager**: 加载和组织配准数据
2. **Coarse Registration**: 使用基准点进行粗配准 (推荐先做)
3. **Gold Standard Set**: 手动精细配准设置金标准 (用于评估)
4. **(后续模块)**: 基于互信息的自动精配准
5. **(后续模块)**: 配准精度评估和可视化
