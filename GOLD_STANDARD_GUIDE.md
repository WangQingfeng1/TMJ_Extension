# Gold Standard Set 模块使用指南

## 模块简介

Gold Standard Set 模块用于手动配准并建立金标准点对，用于评估配准方法的 TRE (Target Registration Error)。

**核心特性**:
- ✅ **相似变换 (Similarity Transform)**: 支持平移、旋转和**统一缩放**
- ✅ **自定义命名**: 可以自定义变换节点的名称
- ✅ **集成控制**: 所有变换控制（平移、旋转、缩放）集成在一起
- ✅ **实时预览**: 调整滑块时实时查看配准效果
- ✅ **自动点对**: 放置标注点时自动在相同位置创建点对

## 主要功能

### 1. 手动配准功能 - 相似变换

**支持的变换类型: 相似变换 (Similarity Transform)**
- **平移 (Translation)**: X, Y, Z 方向移动
- **旋转 (Rotation)**: 绕 X, Y, Z 轴旋转
- **统一缩放 (Uniform Scale)**: 所有方向同时缩放，保持形状比例

**工作流程**:

1. **选择数据**: 从场景中选择 Fixed Volume (CT) 和 Moving Volume (MR)

2. **自定义变换名称**（可选）:
   - 在"变换名称"输入框中输入自定义名称
   - 默认名称: `ManualSimilarityTransform`
   - 例如: `CT_MR_Manual_Registration`, `Patient01_Transform` 等

3. **应用变换节点**: 
   - 点击"应用变换到 Moving"按钮
   - 系统会自动创建线性变换节点（使用您自定义的名称）
   - 变换控制滑块自动启用

4. **使用快捷变换控制**:
   
   **平移控制**:
   - X: 左右移动 (-200mm ~ +200mm)
   - Y: 前后移动 (-200mm ~ +200mm)
   - Z: 上下移动 (-200mm ~ +200mm)
   
   **旋转控制**:
   - X: 绕 X 轴旋转 (-180° ~ +180°)
   - Y: 绕 Y 轴旋转 (-180° ~ +180°)
   - Z: 绕 Z 轴旋转 (-180° ~ +180°)
   
   **统一缩放控制** (相似变换特征):
   - 统一缩放所有方向 (0.5x ~ 2.0x)
   - 保持形状比例不变
   - ⚠️ 注意: 相似变换只支持统一缩放，不支持各轴独立缩放

5. **实时调整**:
   - 拖动滑块时,Moving Volume 会实时变换
   - 可以在不同视图（Axial, Sagittal, Coronal, 3D）中观察效果
   - 点击"重置变换"按钮恢复到初始状态

6. **高级调整（可选）**:
   - 点击"打开 Transforms 模块"进行更精细的调整
   - Transforms 模块会自动选中当前的变换节点

### 2. 标注点对管理

**特点**: 自动同步点对 - 每放置一个点,会在**相同的物理坐标**同时创建 Fixed 和 Moving 标注点

**操作步骤**:

1. **创建标注点节点**:
   - Fixed 和 Moving 标注点选择器会自动创建节点
   - 或者选择已存在的标注点节点

2. **放置点对**:
   - 点击"放置点对"按钮激活放置模式
   - 在切片视图或 3D 视图中点击需要标注的解剖位置
   - 每次点击会:
     - 在该位置创建一个 Fixed 标注点
     - 在**相同的物理坐标**自动创建一个 Moving 标注点
     - 两个点形成一对,用于后续 TRE 计算

3. **查看点对数量**:
   - 表格显示 Fixed 和 Moving 的点数
   - 绿色: 点数匹配
   - 红色: 点数不匹配 (异常情况)

4. **清除点对**:
   - 点击"清除所有点"按钮删除所有标注点

### 3. 保存金标准

**保存内容:**
- Fixed Volume (原始)
- Moving Volume (应用变换后硬化)
- 变换矩阵（包含统一缩放信息）
- Fixed 标注点
- Moving 标注点 (应用变换后的位置)

**操作步骤**:

1. 设置子文件夹名称 (默认: `Gold_Standard_Set`)

2. 点击"保存金标准到场景"按钮

3. 数据会保存到场景文件夹结构中:
   ```
   TMJ_配准流程_xxx/
   └── Gold_Standard_Set_xxx/
       ├── GoldStandard_Fixed (Fixed Volume)
       ├── GoldStandard_Moving_Registered (配准后的 Moving Volume)
       ├── GoldStandard_Transform (相似变换矩阵)
       ├── GoldStandard_Fixed_Fiducials (Fixed 标注点)
       └── GoldStandard_Moving_Fiducials (Moving 标注点)
   ```

## 典型工作流程

1. **加载数据** (Data Manager 模块)
   - 使用 Data Manager 模块加载 CT 和 MR 数据到场景

2. **手动配准** - 相似变换
   - 选择 Fixed Volume (CT) 和 Moving Volume (MR)
   - （可选）自定义变换名称，如 `Patient01_Manual`
   - 点击"应用变换到 Moving"
   - 使用**平移滑块**粗略对齐两个 volume
   - 使用**旋转滑块**调整角度
   - 使用**统一缩放滑块**调整 Moving Volume 的整体尺寸（如果有尺度差异）
   - 在不同视图中检查配准质量
   - 如需精细调整,使用"打开 Transforms 模块"

3. **标注点对**
   - 创建或选择 Fixed 和 Moving 标注点节点
   - 点击"放置点对"按钮
   - 在解剖特征点上点击放置点对 (建议 4-10 对点)
   - 确认表格中显示点数匹配

4. **保存金标准**
   - 设置子文件夹名称
   - 点击"保存金标准到场景"
   - 检查日志确认保存成功

## 变换类型说明

### 相似变换 (Similarity Transform) ⭐ 本模块使用

**定义**: 保持形状比例的变换
- 包含: 平移 + 旋转 + **统一缩放**
- 7 个自由度 (3 个平移 + 3 个旋转 + 1 个统一缩放)
- **关键特征**: 所有方向的缩放因子相同（sx = sy = sz = s）
- **保持**: 角度、形状比例
- **改变**: 位置、方向、整体尺寸

**变换矩阵**:
```
[ s*R11  s*R12  s*R13  Tx ]
[ s*R21  s*R22  s*R23  Ty ]
[ s*R31  s*R32  s*R33  Tz ]
[   0      0      0     1  ]
```
其中:
- `R`: 3x3 旋转矩阵
- `s`: 统一缩放因子
- `Tx, Ty, Tz`: X, Y, Z 方向的平移

**构建顺序**: Uniform_Scale → Rotate_X → Rotate_Y → Rotate_Z → Translate

### 与其他变换的比较

| 变换类型 | 平移 | 旋转 | 统一缩放 | 各轴独立缩放 | 自由度 | 保持 |
|---------|-----|-----|---------|------------|-------|------|
| **刚体变换** (Rigid) | ✅ | ✅ | ❌ | ❌ | 6 | 形状、尺寸 |
| **相似变换** (Similarity) ⭐ | ✅ | ✅ | ✅ | ❌ | 7 | 形状比例 |
| **仿射变换** (Affine) | ✅ | ✅ | ✅ | ✅ | 12 | 平行线 |

### 为什么使用相似变换？

**适用场景**:
- ✅ CT 和 MR 存在**整体尺度差异**
- ✅ 不同扫描协议导致的**尺寸不一致**
- ✅ 需要保持形状比例的配准
- ✅ 医学影像配准的常用选择（比刚体灵活，比仿射限制更强）

**不适用场景**:
- ❌ 需要各轴独立缩放（→ 使用仿射变换）
- ❌ 有明显的非线性变形（→ 使用非刚体配准）

## 使用技巧

### 配准顺序建议

1. **先平移**: 使用 X, Y, Z 平移滑块将两个 volume 大致对齐
2. **再旋转**: 使用旋转滑块调整角度
3. **后缩放**: 如果有尺度差异,使用统一缩放（保持形状比例）
4. **微调**: 来回调整直到满意

### 统一缩放使用建议

- **何时使用**: 当 Fixed 和 Moving 的整体尺寸有差异时
- **缩放范围**: 0.5x ~ 2.0x (如需更大范围可在代码中调整)
- **注意**: 缩放会同时改变 X, Y, Z 三个方向，保持形状比例
- **检查**: 在多个视图中确认缩放效果

### 自定义变换名称建议

- **患者编号**: `Patient01_Manual`, `Subject_A_Transform`
- **日期时间**: `Manual_20251022`, `Transform_1022_143000`
- **配准类型**: `CT_MR_Similarity`, `Coarse_Registration`
- **避免**: 特殊字符，使用下划线或驼峰命名

### 标注点对建议

1. **数量**: 4-10 对点,覆盖感兴趣区域
2. **分布**: 尽量均匀分布,不要集中在一个区域
3. **特征**: 选择易于识别的解剖标志点
4. **质量**: 手动配准要尽可能准确,这是"金标准"

## 快速重载模块

如果需要修改代码并重新加载模块:

```python
# 在 Slicer 的 Python console 中运行
exec(open(r"E:\图像处理\TMJ_Extension\reload_module.py").read())
reloadTMJExtension()
```

## 问题排查

### 点对数量不匹配 (显示红色)
- 原因: 自动同步失败或手动修改了标注点
- 解决: 清除所有点后重新放置

### 变换无效 (Moving 没有移动)
- 原因: 变换未应用到 Moving Volume
- 解决: 确保点击了"应用变换到 Moving"按钮

### 滑块无法使用
- 原因: 变换控制未启用
- 解决: 先点击"应用变换到 Moving"按钮

### 缩放后图像看起来变形
- 原因: 这是正常的，统一缩放会改变整体尺寸
- 解决: 调整缩放因子，或检查是否需要各轴独立缩放（需切换到仿射变换）

### 保存失败
- 原因: 未选择必要的数据节点
- 解决: 检查所有选择器都有选中的节点

### 找不到自定义名称的变换
- 原因: 变换名称可能被自动修改
- 解决: 在变换节点下拉框中查找，或重新创建

## 联系与反馈

如有问题或建议,请联系开发团队。

1. **选择数据**: 从场景中选择 Fixed Volume (CT) 和 Moving Volume (MR)

2. **应用变换节点**: 
   - 点击"应用变换到 Moving"按钮
   - 系统会自动创建线性变换节点（vtkMRMLLinearTransformNode）
   - 变换控制滑块自动启用

3. **使用快捷变换控制**:
   
   **平移控制**:
   - X: 左右移动 (-200mm ~ +200mm)
   - Y: 前后移动 (-200mm ~ +200mm)
   - Z: 上下移动 (-200mm ~ +200mm)
   
   **旋转控制**:
   - X: 绕 X 轴旋转 (-180° ~ +180°)
   - Y: 绕 Y 轴旋转 (-180° ~ +180°)
   - Z: 绕 Z 轴旋转 (-180° ~ +180°)
   
   **缩放控制** (相似变换特有):
   - **统一缩放**: 同时缩放 X, Y, Z 轴 (0.5x ~ 2.0x)
   - **X 轴缩放**: 单独缩放 X 方向 (0.5x ~ 2.0x)
   - **Y 轴缩放**: 单独缩放 Y 方向 (0.5x ~ 2.0x)
   - **Z 轴缩放**: 单独缩放 Z 方向 (0.5x ~ 2.0x)

4. **实时调整**:
   - 拖动滑块时,Moving Volume 会实时变换
   - 可以在不同视图（Axial, Sagittal, Coronal, 3D）中观察效果
   - 点击"重置变换"按钮恢复到初始状态

5. **高级调整（可选）**:
   - 点击"打开 Transforms 模块"进行更精细的调整
   - Transforms 模块会自动选中当前的变换节点

### 2. 标注点对管理

**特点**: 自动同步点对 - 每放置一个点,会在**相同的物理坐标**同时创建 Fixed 和 Moving 标注点

**操作步骤**:

1. **创建标注点节点**:
   - Fixed 和 Moving 标注点选择器会自动创建节点
   - 或者选择已存在的标注点节点

2. **放置点对**:
   - 点击"放置点对"按钮激活放置模式
   - 在切片视图或 3D 视图中点击需要标注的解剖位置
   - 每次点击会:
     - 在该位置创建一个 Fixed 标注点
     - 在**相同的物理坐标**自动创建一个 Moving 标注点
     - 两个点形成一对,用于后续 TRE 计算

3. **查看点对数量**:
   - 表格显示 Fixed 和 Moving 的点数
   - 绿色: 点数匹配
   - 红色: 点数不匹配 (异常情况)

4. **清除点对**:
   - 点击"清除所有点"按钮删除所有标注点

### 3. 保存金标准

**保存内容:**
- Fixed Volume (原始)
- Moving Volume (应用变换后硬化)
- 变换矩阵（包含缩放信息）
- Fixed 标注点
- Moving 标注点 (应用变换后的位置)

**操作步骤**:

1. 设置子文件夹名称 (默认: `Gold_Standard_Set`)

2. 点击"保存金标准到场景"按钮

3. 数据会保存到场景文件夹结构中:
   ```
   TMJ_配准流程_xxx/
   └── Gold_Standard_Set_xxx/
       ├── GoldStandard_Fixed (Fixed Volume)
       ├── GoldStandard_Moving_Registered (配准后的 Moving Volume)
       ├── GoldStandard_Transform (变换矩阵 - 包含缩放)
       ├── GoldStandard_Fixed_Fiducials (Fixed 标注点)
       └── GoldStandard_Moving_Fiducials (Moving 标注点)
   ```

## 典型工作流程

1. **加载数据** (Data Manager 模块)
   - 使用 Data Manager 模块加载 CT 和 MR 数据到场景

2. **手动配准** - 相似变换
   - 选择 Fixed Volume (CT) 和 Moving Volume (MR)
   - 点击"应用变换到 Moving"
   - 使用**平移滑块**粗略对齐两个 volume
   - 使用**旋转滑块**调整角度
   - 使用**缩放滑块**调整 Moving Volume 的尺寸（如果有尺度差异）
   - 在不同视图中检查配准质量
   - 如需精细调整,使用"打开 Transforms 模块"

3. **标注点对**
   - 创建或选择 Fixed 和 Moving 标注点节点
   - 点击"放置点对"按钮
   - 在解剖特征点上点击放置点对 (建议 4-10 对点)
   - 确认表格中显示点数匹配

4. **保存金标准**
   - 设置子文件夹名称
   - 点击"保存金标准到场景"
   - 检查日志确认保存成功

## 相似变换 vs 刚体变换

### 刚体变换 (Rigid Transform)
- 只包含: 平移 + 旋转
- 保持物体的形状和尺寸不变
- 6 个自由度 (3 个平移 + 3 个旋转)

### 相似变换 (Similarity Transform) ⭐ 本模块使用
- 包含: 平移 + 旋转 + **缩放**
- 允许整体或各轴独立缩放
- 7-9 个自由度 (3 个平移 + 3 个旋转 + 1-3 个缩放)
- **适用场景**: 
  - CT 和 MR 存在尺度差异
  - 不同扫描协议导致的尺寸不一致
  - 需要更灵活的配准

## 使用技巧

### 配准顺序建议

1. **先平移**: 使用 X, Y, Z 平移滑块将两个 volume 大致对齐
2. **再旋转**: 使用旋转滑块调整角度
3. **后缩放**: 如果有尺度差异,使用统一缩放或各轴缩放
4. **微调**: 来回调整直到满意

### 缩放使用建议

- **统一缩放**: 当整体尺寸有差异时使用（推荐先用这个）
- **各轴独立缩放**: 当某个方向有特殊的尺度差异时使用
- **缩放范围**: 0.5x ~ 2.0x (如需更大范围可在代码中调整)

### 标注点对建议

1. **数量**: 4-10 对点,覆盖感兴趣区域
2. **分布**: 尽量均匀分布,不要集中在一个区域
3. **特征**: 选择易于识别的解剖标志点
4. **质量**: 手动配准要尽可能准确,这是"金标准"

## 变换矩阵说明

本模块使用的变换矩阵是 4x4 齐次变换矩阵:

```
[ sx*R11  sy*R12  sz*R13  Tx ]
[ sx*R21  sy*R22  sz*R23  Ty ]
[ sx*R31  sy*R32  sz*R33  Tz ]
[   0       0       0      1  ]
```

其中:
- `R`: 3x3 旋转矩阵
- `sx, sy, sz`: X, Y, Z 方向的缩放因子
- `Tx, Ty, Tz`: X, Y, Z 方向的平移

**构建顺序**: Scale → Rotate_X → Rotate_Y → Rotate_Z → Translate

## 快速重载模块

如果需要修改代码并重新加载模块:

```python
# 在 Slicer 的 Python console 中运行
exec(open(r"E:\图像处理\TMJ_Extension\reload_module.py").read())
reloadTMJExtension()
```

## 问题排查

### 点对数量不匹配 (显示红色)
- 原因: 自动同步失败或手动修改了标注点
- 解决: 清除所有点后重新放置

### 变换无效 (Moving 没有移动)
- 原因: 变换未应用到 Moving Volume
- 解决: 确保点击了"应用变换到 Moving"按钮

### 滑块无法使用
- 原因: 变换控制未启用
- 解决: 先点击"应用变换到 Moving"按钮

### 缩放后图像变形
- 原因: 各轴缩放因子不一致
- 解决: 使用"统一缩放"或点击"重置变换"恢复

### 保存失败
- 原因: 未选择必要的数据节点
- 解决: 检查所有选择器都有选中的节点

## 联系与反馈

如有问题或建议,请联系开发团队。
