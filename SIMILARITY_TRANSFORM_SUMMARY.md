# 相似变换实现总结

## ✅ 已完成的改进

### 1. 变换类型：从刚体变换到相似变换

**之前**: 
- 只支持平移和旋转（6自由度）
- 无法处理尺度差异

**现在**: 
- 支持平移、旋转和**统一缩放**（7自由度）
- 符合相似变换的数学定义
- 保持形状比例不变

### 2. 自定义变换名称

**功能**:
- 添加了"变换名称"输入框
- 用户可以自定义变换节点的名称
- 默认名称: `ManualSimilarityTransform`

**用途**:
- 区分不同患者的配准
- 标注配准时间或版本
- 便于后续管理和追踪

### 3. 简化的缩放控制

**删除**:
- ❌ X 轴独立缩放
- ❌ Y 轴独立缩放
- ❌ Z 轴独立缩放

**保留**:
- ✅ 统一缩放（相似变换的特征）

**原因**:
- 相似变换的定义要求所有方向的缩放因子相同
- 各轴独立缩放属于仿射变换（Affine Transform）
- 统一缩放保持形状比例，更符合医学影像配准需求

## 数学原理

### 相似变换矩阵

```
T_similarity = Translation * Rotation * Uniform_Scale

[ s*R11  s*R12  s*R13  Tx ]
[ s*R21  s*R22  s*R23  Ty ]
[ s*R31  s*R32  s*R33  Tz ]
[   0      0      0     1  ]
```

其中:
- `R`: 3×3 旋转矩阵（正交矩阵）
- `s`: 统一缩放因子（标量）
- `T`: 平移向量 [Tx, Ty, Tz]

### 代码实现

```python
def onTransformChanged(self):
    # 获取参数
    tx, ty, tz = 平移参数
    rx, ry, rz = 旋转参数
    s = 统一缩放参数  # 关键：只有一个缩放值
    
    # 1. 构建统一缩放矩阵
    scaleMatrix = Identity * s  # 对角线元素都是 s
    
    # 2. 构建旋转矩阵
    rotationMatrix = Rz(rz) * Ry(ry) * Rx(rx)
    
    # 3. 组合
    combined = rotationMatrix * scaleMatrix
    
    # 4. 添加平移
    combined[0:3, 3] = [tx, ty, tz]
```

## UI 布局

```
┌─────────────────────────────────────────┐
│ 2. 手动配准:                              │
├─────────────────────────────────────────┤
│ 变换名称: [ManualSimilarityTransform]    │
│ 变换节点: [下拉选择框]                     │
│ [应用变换到 Moving] [打开Transforms模块]  │
├─────────────────────────────────────────┤
│ 快捷变换控制:                             │
│                                          │
│ ┌─ 平移 (Translation) ──────────────┐   │
│ │ X: [========|==============] mm   │   │
│ │ Y: [========|==============] mm   │   │
│ │ Z: [========|==============] mm   │   │
│ └─────────────────────────────────────┘   │
│                                          │
│ ┌─ 旋转 (Rotation) ───────────────┐   │
│ │ X: [========|==============] °    │   │
│ │ Y: [========|==============] °    │   │
│ │ Z: [========|==============] °    │   │
│ └─────────────────────────────────────┘   │
│                                          │
│ ┌─ 缩放 (Scale) - 相似变换 ──────┐   │
│ │ 说明: 相似变换只支持统一缩放      │   │
│ │ 统一缩放: [====|===========] x   │   │
│ └─────────────────────────────────────┘   │
│                                          │
│ [重置变换]                                │
└─────────────────────────────────────────┘
```

## 变换类型对比

| 特性 | 刚体变换 | 相似变换 ⭐ | 仿射变换 |
|------|---------|-----------|---------|
| 平移 | ✅ | ✅ | ✅ |
| 旋转 | ✅ | ✅ | ✅ |
| 统一缩放 | ❌ | ✅ | ✅ |
| 各轴独立缩放 | ❌ | ❌ | ✅ |
| 剪切 | ❌ | ❌ | ✅ |
| 自由度 | 6 | 7 | 12 |
| 保持 | 距离、角度、形状、尺寸 | 角度、形状比例 | 平行线、面积比 |
| 适用 | 同一扫描协议 | 尺度差异配准 | 复杂几何变形 |

## 使用场景

### ✅ 适合相似变换的场景

1. **CT 和 MR 配准**，存在整体尺度差异
2. **不同扫描协议**导致的尺寸不一致
3. **不同时间点**的扫描，患者可能有轻微尺寸变化
4. 需要**保持形状比例**的配准任务

### ❌ 不适合的场景

1. **各轴尺度差异不同** → 需要仿射变换
2. **存在明显剪切变形** → 需要仿射变换
3. **非线性变形** → 需要非刚体配准（如 B-spline, Demons）
4. **完全相同的扫描协议** → 刚体变换即可

## 工作流程

```
用户操作流程:
1. 输入自定义变换名称（可选）
   ↓
2. 选择 Fixed 和 Moving Volume
   ↓
3. 点击"应用变换到 Moving"
   → 自动创建线性变换节点
   → 使用自定义名称
   → 启用滑块控制
   ↓
4. 使用滑块调整:
   - 平移: 粗略对齐
   - 旋转: 调整角度
   - 统一缩放: 调整尺寸（保持形状比例）
   ↓
5. 实时查看效果
   ↓
6. 满意后放置标注点对
   ↓
7. 保存金标准到场景
```

## 代码改动清单

### 1. UI 改动

**添加**:
- `self.transformNameEdit`: 变换名称输入框

**修改**:
- `self.transformSelector.nodeTypes`: `["vtkMRMLLinearTransformNode"]`
- `self.transformSelector.baseName`: `"ManualSimilarityTransform"`

**删除**:
- `self.scaleXSlider`: X 轴缩放滑块
- `self.scaleYSlider`: Y 轴缩放滑块
- `self.scaleZSlider`: Z 轴缩放滑块

**保留**:
- `self.uniformScaleSlider`: 统一缩放滑块

### 2. 方法改动

**onApplyTransform()**:
- 添加了读取自定义变换名称的逻辑
- 使用 `self.transformNameEdit.text` 创建变换节点

**onTransformChanged()**:
- 简化了缩放矩阵构建
- 只使用 `self.uniformScaleSlider.value`
- 删除了 `sx, sy, sz` 分别处理的代码

**enableTransformControls()**:
- 删除了 X/Y/Z 独立缩放滑块的启用/禁用

**onResetTransform()**:
- 删除了 X/Y/Z 独立缩放滑块的重置

**删除**:
- `onUniformScaleChanged()`: 不再需要同步各轴缩放

## 测试建议

### 基础测试

1. **变换名称自定义**:
   - 输入自定义名称，验证变换节点名称正确
   - 留空，验证使用默认名称

2. **统一缩放**:
   - 调整缩放滑块，验证 Moving Volume 等比例缩放
   - 在多个视图中确认形状比例保持不变

3. **组合变换**:
   - 同时调整平移、旋转、缩放
   - 验证变换顺序正确（Scale → Rotate → Translate）

4. **重置功能**:
   - 调整参数后点击重置
   - 验证所有参数回到初始值

### 高级测试

1. **与 Transforms 模块对比**:
   - 使用快捷控制配准
   - 在 Transforms 模块中查看矩阵
   - 验证矩阵格式正确（相似变换）

2. **金标准保存**:
   - 完成配准后保存
   - 验证变换矩阵被正确保存
   - 检查硬化后的 Moving Volume

3. **极限值测试**:
   - 最大缩放 (2.0x)
   - 最小缩放 (0.5x)
   - 验证图像质量和可见性

## 文档更新

- ✅ `GOLD_STANDARD_GUIDE.md`: 更新了完整的使用指南
- ✅ `SIMILARITY_TRANSFORM_SUMMARY.md`: 本文档（技术总结）

## 未来改进方向

1. **缩放范围调整**: 可根据实际需求扩大缩放范围
2. **变换预设**: 保存和加载常用的变换参数
3. **配准质量评估**: 自动计算配准指标（如互信息、相关系数）
4. **仿射变换支持**: 如果需要各轴独立缩放，添加仿射变换选项
5. **变换历史**: 记录变换参数的变化历史，支持撤销/重做

## 总结

✅ **成功实现了符合数学定义的相似变换**
✅ **简化了界面，移除了不符合相似变换定义的独立轴缩放**
✅ **添加了自定义变换名称功能，提高了可用性**
✅ **保持了实时预览、集成控制等核心优势**

这个实现既保持了相似变换的数学准确性，又提供了直观易用的界面，非常适合医学影像配准任务！
